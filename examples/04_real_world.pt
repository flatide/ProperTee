// ==================================================
// ProperTee 실전 응용 예제
// 현실적인 사용 사례와 패턴
// ==================================================

// --------------------------
// 1. 환경별 설정 관리
// --------------------------

environment = "production"

all_config = {
    development: {
        debug: true,
        log_level: "debug",
        api_url: "http://localhost:3000/api",
        database: {
            host: "localhost",
            port: 5432,
            name: "app_dev"
        }
    },
    staging: {
        debug: true,
        log_level: "info",
        api_url: "https://staging-api.example.com",
        database: {
            host: "staging-db.example.com",
            port: 5432,
            name: "app_staging"
        }
    },
    production: {
        debug: false,
        log_level: "error",
        api_url: "https://api.example.com",
        database: {
            host: "prod-db.example.com",
            port: 5432,
            name: "app_prod"
        }
    }
}

// 현재 환경 설정 가져오기
config = all_config.$environment
db_host = config.database.host
api_endpoint = config.api_url


// --------------------------
// 2. API 응답 파싱
// --------------------------

api_response = {
    status: 200,
    message: "success",
    data: {
        pagination: {
            page: 1,
            per_page: 10,
            total: 45
        },
        items: [
            {id: 101, type: "article", title: "Getting Started", views: 1250},
            {id: 102, type: "video", title: "Tutorial", views: 3400},
            {id: 103, type: "article", title: "Advanced Tips", views: 890},
            {id: 104, type: "podcast", title: "Interview", views: 560}
        ]
    }
}

// 응답 상태 확인
if api_response.status == 200 then
    items = api_response.data.items
    total_pages = api_response.data.pagination.total / api_response.data.pagination.per_page
    
    // 타입별 분류
    articles = []
    videos = []
    others = []
    
    for item in items do
        if item.type == "article" then
            push(articles, item)
        else
            if item.type == "video" then
                push(videos, item)
            else
                push(others, item)
            end
        end
    end
else
    error_msg = "API Error: " + api_response.message
end


// --------------------------
// 3. 데이터 변환 및 매핑
// --------------------------

// 원본 데이터 (외부 시스템 형식)
raw_data = [
    {usr_nm: "Alice Kim", usr_email: "alice@mail.com", usr_age: 28},
    {usr_nm: "Bob Lee", usr_email: "bob@mail.com", usr_age: 35},
    {usr_nm: "Charlie Park", usr_email: "charlie@mail.com", usr_age: 42}
]

// 필드 매핑 정의
field_map = {
    usr_nm: "name",
    usr_email: "email",
    usr_age: "age"
}

// 변환 수행
transformed_data = []

for record in raw_data do
    new_record = {}
    
    for old_key, new_key in field_map do
        new_record.$new_key = record.$old_key
    end
    
    push(transformed_data, new_record)
end

// 결과: [{name: "Alice Kim", email: "alice@mail.com", age: 28}, ...]


// --------------------------
// 4. 폼 데이터 검증
// --------------------------

form_data = {
    username: "john_doe",
    email: "john@example.com",
    password: "secret",
    age: 25
}

validation_rules = {
    username: {required: true, min_length: 3},
    email: {required: true},
    password: {required: true, min_length: 8},
    age: {required: false}
}

errors = []

for field, rules in validation_rules do
    value = form_data.$field
    
    // 필수 필드 검사
    if rules.required == true then
        if value == null or value == "" then
            push(errors, field + " is required")
            continue
        end
    end
    
    // 최소 길이 검사 (문자열인 경우)
    if rules.min_length != null then
        if strlen(value) < rules.min_length then
            push(errors, field + " must be at least " + rules.min_length + " characters")
        end
    end
end

is_valid = length(errors) == 0


// --------------------------
// 5. 트리 구조 탐색
// --------------------------

// 파일 시스템 구조
file_tree = {
    name: "root",
    type: "folder",
    children: [
        {
            name: "documents",
            type: "folder",
            children: [
                {name: "report.pdf", type: "file", size: 1024},
                {name: "notes.txt", type: "file", size: 256}
            ]
        },
        {
            name: "images",
            type: "folder",
            children: [
                {name: "photo.jpg", type: "file", size: 2048},
                {name: "icon.png", type: "file", size: 128}
            ]
        },
        {name: "readme.md", type: "file", size: 512}
    ]
}

// 모든 파일 크기 합계 (1단계 깊이만)
total_size = 0

for item in file_tree.children do
    if item.type == "file" then
        total_size = total_size + item.size
    else
        // 하위 폴더 탐색
        for child in item.children do
            if child.type == "file" then
                total_size = total_size + child.size
            end
        end
    end
end


// --------------------------
// 6. 이벤트 처리 시스템
// --------------------------

event_handlers = {
    click: "handleClick",
    hover: "handleHover",
    submit: "handleSubmit",
    keypress: "handleKeypress"
}

event = {
    type: "click",
    target: "button_1",
    data: {x: 100, y: 200}
}

// 이벤트 타입에 맞는 핸들러 찾기
handler_name = event_handlers.$(event.type)

if handler_name != null then
    call(handler_name, event)
else
    log("No handler for event: " + event.type)
end


// --------------------------
// 7. 다국어 지원 (i18n)
// --------------------------

current_lang = "ko"

translations = {
    en: {
        greeting: "Hello",
        farewell: "Goodbye",
        error_required: "This field is required",
        error_invalid: "Invalid value"
    },
    ko: {
        greeting: "안녕하세요",
        farewell: "안녕히 가세요",
        error_required: "이 필드는 필수입니다",
        error_invalid: "잘못된 값입니다"
    },
    ja: {
        greeting: "こんにちは",
        farewell: "さようなら",
        error_required: "この項目は必須です",
        error_invalid: "無効な値です"
    }
}

// 번역 함수
t_key = "greeting"
message = translations.$current_lang.$t_key    // "안녕하세요"

// 폴백 처리 포함
get_translation = {
    key: "unknown_key",
    lang: current_lang
}

text = translations.$(get_translation.lang).$(get_translation.key)
if text == null then
    text = translations.en.$(get_translation.key)    // 영어로 폴백
    if text == null then
        text = get_translation.key                   // 키 자체 반환
    end
end


// --------------------------
// 8. 쿼리 빌더 패턴
// --------------------------

query_params = {
    table: "users",
    fields: ["id", "name", "email"],
    where: {
        active: true,
        age_gte: 18
    },
    order_by: "created_at",
    limit: 10
}

// SELECT 절 생성
select_clause = "SELECT "
field_idx = 0
for field in query_params.fields do
    if field_idx > 0 then
        select_clause = select_clause + ", "
    end
    select_clause = select_clause + field
    field_idx = field_idx + 1
end

// FROM 절
from_clause = " FROM " + query_params.table

// WHERE 절 생성
where_clause = " WHERE "
condition_idx = 0
for col, val in query_params.where do
    if condition_idx > 0 then
        where_clause = where_clause + " AND "
    end
    where_clause = where_clause + col + " = " + val
    condition_idx = condition_idx + 1
end

// 최종 쿼리
full_query = select_clause + from_clause + where_clause


// --------------------------
// 9. 상태 기계 (State Machine)
// --------------------------

order_states = {
    pending: {
        next: ["confirmed", "cancelled"],
        action: "waitForConfirmation"
    },
    confirmed: {
        next: ["shipped", "cancelled"],
        action: "prepareShipment"
    },
    shipped: {
        next: ["delivered"],
        action: "trackDelivery"
    },
    delivered: {
        next: [],
        action: "completeOrder"
    },
    cancelled: {
        next: [],
        action: "refundPayment"
    }
}

current_state = "confirmed"
requested_state = "shipped"

// 전이 가능 여부 확인
state_config = order_states.$current_state
can_transition = false

for allowed in state_config.next do
    if allowed == requested_state then
        can_transition = true
        break
    end
end

if can_transition then
    current_state = requested_state
    new_action = order_states.$current_state.action
    execute(new_action)
else
    error = "Cannot transition from " + current_state + " to " + requested_state
end


// --------------------------
// 10. 테스트 데이터 생성
// --------------------------

test_users = []
base_data = {
    domain: "test.com",
    default_role: "user"
}

i = 1
while i <= 5 do
    user = {
        id: i,
        username: "user_" + i,
        email: "user" + i + "@" + base_data.domain,
        role: base_data.default_role,
        active: true
    }
    
    // 첫 번째 사용자는 관리자
    if i == 1 then
        user.role = "admin"
    end
    
    push(test_users, user)
    i = i + 1
end
