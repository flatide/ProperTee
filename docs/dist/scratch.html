<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ProperTee Concurrent - Scratch</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .button-group {
            margin: 15px 0;
        }
        .btn {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
        }
        .btn-danger {
            background-color: #f44336;
            color: white;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #output {
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 15px;
            background-color: #f9f9f9;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .demo-btn {
            padding: 6px 12px;
            margin: 3px;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            background: #fff;
        }
        .demo-btn:hover {
            background: #e8e8e8;
        }
        textarea {
            width: 100%;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>ProperTee Concurrent - Generator-Based Cooperative Scheduler</h1>

    <h3>Properties (JSON):</h3>
    <textarea id="properties" rows="3" cols="50">{"user": {"name": "Test", "score": 100}}</textarea>

    <h3>Demo Scripts:</h3>
    <div>
        <button class="demo-btn" onclick="loadDemo('basic')">Basic (No Threads)</button>
        <button class="demo-btn" onclick="loadDemo('interleave')">Interleaved PRINT</button>
        <button class="demo-btn" onclick="loadDemo('sleep')">SLEEP Interleaving</button>
        <button class="demo-btn" onclick="loadDemo('monitor')">MONITOR</button>
        <button class="demo-btn" onclick="loadDemo('results')">Thread Results</button>
    </div>

    <h3>Script:</h3>
    <textarea id="script" rows="20" cols="50">/* Interleaved PRINT Demo */

thread worker(name, count) do
    i = 0
    loop i < count infinite do
        PRINT(name + ": step " + TO_STRING(i + 1))
        i = i + 1
    end
    return count
end

multi
    worker("Alpha", 4) -> r1
    worker("Beta", 4) -> r2
    worker("Gamma", 4) -> r3
end

PRINT("=== All threads done ===")
PRINT("Alpha result:", r1)
PRINT("Beta result:", r2)
PRINT("Gamma result:", r3)
</textarea>

    <div class="button-group">
        <button class="btn btn-primary" id="runButton" onclick="run()">Run</button>
        <button class="btn btn-danger" onclick="clearOutput()">Clear Output</button>
    </div>

    <h3>Output:</h3>
    <div id="output"></div>

    <!-- ProperTee Concurrent bundle -->
    <script src="./propertee-bundle.js"></script>

    <script>
        // Demo scripts
        const demos = {
            basic: `/* Basic script - no threads */
x = 10
y = 20
PRINT("x + y =", x + y)

function greet(name) do
    return "Hello, " + name + "!"
end

PRINT(greet("World"))

items = [1, 2, 3, 4, 5]
total = 0
loop v in items do
    total = total + v
end
PRINT("Sum:", total)`,

            interleave: `/* Interleaved PRINT Demo */
/* Threads yield after every statement, so PRINTs should interleave */

thread worker(name, count) do
    i = 0
    loop i < count infinite do
        PRINT(name + ": step " + TO_STRING(i + 1))
        i = i + 1
    end
    return count
end

multi
    worker("Alpha", 4) -> r1
    worker("Beta", 4) -> r2
    worker("Gamma", 4) -> r3
end

PRINT("=== All threads done ===")
PRINT("Alpha result:", r1)
PRINT("Beta result:", r2)
PRINT("Gamma result:", r3)`,

            sleep: `/* SLEEP Interleaving Demo */
/* Sleeping threads don't block others */

thread fast(name) do
    PRINT(name + ": starting fast work")
    PRINT(name + ": step 1")
    PRINT(name + ": step 2")
    PRINT(name + ": step 3")
    PRINT(name + ": done!")
    return "fast-done"
end

thread sleepy(name, ms) do
    PRINT(name + ": starting, will sleep " + TO_STRING(ms) + "ms")
    SLEEP(ms)
    PRINT(name + ": woke up!")
    return "slept-" + TO_STRING(ms)
end

multi
    sleepy("Sleeper", 100) -> r1
    fast("Worker") -> r2
end

PRINT("=== Results ===")
PRINT("Sleeper:", r1)
PRINT("Worker:", r2)`,

            monitor: `/* MONITOR Demo */
/* Monitor runs periodically between scheduler ticks */

thread counter(name, target) do
    i = 0
    loop i < target infinite do
        i = i + 1
    end
    PRINT(name + " finished counting to " + TO_STRING(target))
    return i
end

multi
    counter("A", 10) -> rA
    counter("B", 8) -> rB
monitor 50
    PRINT("[Monitor tick]")
end

PRINT("=== Results ===")
PRINT("A counted:", rA)
PRINT("B counted:", rB)`,

            results: `/* Thread Results Demo */

thread calculate(n) do
    temp = n * 2
    squared = temp * temp
    result = squared + n
    PRINT("Thread", n, "calculated:", result)
    return result
end

thread buildObject(id) do
    obj = {
        id: id,
        value: id * 100,
        status: "complete"
    }
    PRINT("Thread", id, "built object")
    return obj
end

multi
    calculate(5) -> r1
    calculate(3) -> r2
    buildObject(99) -> r3
end

PRINT("=== Results ===")
PRINT("r1 (calculate 5):", r1)
PRINT("r2 (calculate 3):", r2)
PRINT("r3 (buildObject):", r3)
PRINT("r3.id:", r3.id)
PRINT("r3.value:", r3.value)
PRINT("r3.status:", r3.status)`
        };

        function loadDemo(name) {
            document.getElementById('script').value = demos[name];
        }

        // Error listener
        class ErrorListener extends antlr4.error.ErrorListener {
            constructor() {
                super();
                this.errors = [];
            }
            syntaxError(recognizer, offendingSymbol, line, column, msg, err) {
                this.errors.push(`Line ${line}:${column} - ${msg}`);
            }
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        async function run() {
            const output = document.getElementById('output');
            const runButton = document.getElementById('runButton');
            const propertiesText = document.getElementById('properties').value;
            const scriptText = document.getElementById('script').value;

            output.innerHTML = '';
            runButton.disabled = true;
            runButton.textContent = 'Running...';

            try {
                const properties = JSON.parse(propertiesText);

                // Parse
                const chars = new antlr4.InputStream(scriptText);
                const lexer = new ProperTeeLexer(chars);
                const lexerErrors = new ErrorListener();
                lexer.removeErrorListeners();
                lexer.addErrorListener(lexerErrors);

                const tokens = new antlr4.CommonTokenStream(lexer);
                const parser = new ProperTeeParser(tokens);
                const parserErrors = new ErrorListener();
                parser.removeErrorListeners();
                parser.addErrorListener(parserErrors);

                const tree = parser.root();

                if (lexerErrors.errors.length > 0) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = 'red';
                    errorDiv.textContent = 'Lexer Error:\n' + lexerErrors.errors.join('\n');
                    output.appendChild(errorDiv);
                    return;
                }
                if (parserErrors.errors.length > 0) {
                    const errorDiv = document.createElement('div');
                    errorDiv.style.color = 'red';
                    errorDiv.textContent = 'Parser Error:\n' + parserErrors.errors.join('\n');
                    output.appendChild(errorDiv);
                    return;
                }

                // IO streams
                const ioStreams = {
                    stdout: (...args) => {
                        const line = args.join(' ');
                        const div = document.createElement('div');
                        div.textContent = line;
                        output.appendChild(div);
                        output.scrollTop = output.scrollHeight;
                    },
                    stderr: (...args) => {
                        const line = '[ERROR] ' + args.join(' ');
                        const div = document.createElement('div');
                        div.style.color = 'red';
                        div.textContent = line;
                        output.appendChild(div);
                        output.scrollTop = output.scrollHeight;
                    }
                };

                const options = {
                    maxIterations: 1000,
                    iterationLimitBehavior: 'error'
                };

                // Create visitor and scheduler
                const visitor = new ProperTeeCustomVisitor(properties, {}, ioStreams, options);
                const scheduler = new Scheduler(visitor);
                const mainGenerator = visitor.visitRoot(tree);
                const result = await scheduler.run(mainGenerator);

                // Summary
                const summary = document.createElement('div');
                summary.style.marginTop = '20px';
                summary.style.borderTop = '2px solid #ccc';
                summary.style.paddingTop = '10px';
                summary.style.fontFamily = 'monospace';
                summary.style.fontSize = '12px';
                summary.innerHTML = `
                    <strong>--- Return Value ---</strong>
                    <pre style="margin: 5px 0;">${JSON.stringify(result, null, 2)}</pre>

                    <strong>--- Variables ---</strong>
                    <pre style="margin: 5px 0;">${JSON.stringify(visitor.variables, null, 2)}</pre>
                `;
                output.appendChild(summary);

            } catch (e) {
                const errorDiv = document.createElement('div');
                errorDiv.style.marginTop = '20px';
                errorDiv.style.borderTop = '2px solid red';
                errorDiv.style.paddingTop = '10px';
                errorDiv.style.color = 'red';
                errorDiv.innerHTML = `
                    <strong>--- Runtime Error ---</strong>
                    <pre style="margin: 5px 0;">${e.message}\n\n${e.stack}</pre>
                `;
                output.appendChild(errorDiv);
            } finally {
                runButton.disabled = false;
                runButton.textContent = 'Run';
            }
        }
    </script>
</body>
</html>
